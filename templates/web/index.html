{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩÁÇπÈ§êÁ≥ªÁªü</title>
    
    <link rel="stylesheet" href="{% static 'web/css/common.css' %}">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    
    <div id="app">
        <header class="app-header">
            <div class="brand">
                <img src="{% static 'uploads/shop/' %}{{ request.session.shopinfo.cover_pic }}" 
                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"
                     onerror="this.src='https://placehold.co/40x40?text=Logo'"> 
                     <span>{{request.session.shopinfo.name}}</span>
                <span style="font-size:12px; color:#999; margin-left:10px">{{request.session.shopinfo.shop}}</span>
            </div>
            <nav class="nav-links">
                <a href="#" class="active">Â†ÇÈ£üÁÇπÈ§ê</a>
                <a href="{% url 'web_orders_index' 1 %}?status=1">ÂΩìÂâçËÆ¢Âçï</a>
                <a href="{% url 'web_orders_index' 1 %}?status=3">ÂéÜÂè≤ËÆ¢Âçï</a>
                <a href="{% url 'web_logout' %}">ÈÄÄÂá∫</a>
            </nav>
        </header>

        <div class="main-container">
            
            <aside class="category-sidebar">
                <a v-for="(cat, index) in categories" 
                   :key="cat.id" 
                   class="cat-item"
                   :class="{ active: currentCategory === index }"
                   @click="scrollToCategory(index)">
                   [[ cat.name ]]
                </a>
            </aside>

            <main class="product-area" id="productArea">
                <div v-for="(cat, index) in categories" :key="cat.id" :id="'cat-' + index">
                    <h3 class="category-title">[[ cat.name ]]</h3>
                    <div class="product-grid">
                        <div class="product-card" v-for="prod in cat.pids" :key="prod.id">
                            <img :src="'/static/uploads/product/' + prod.cover_pic" class="p-img">
                            <div class="p-info">
                                <div class="p-name">[[ prod.name ]]</div>
                                <div class="p-action">
                                    <span class="p-price">¬•[[ prod.price ]]</span>
                                    <button class="btn-add" @click="addToCart(prod)">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <aside class="cart-panel">
                <div class="cart-header">
                    Ë¥≠Áâ©ËΩ¶ ([[ totalCount ]])
                    <span style="float:right; font-size:12px; color:#999; cursor:pointer" @click="clearCart">Ê∏ÖÁ©∫</span>
                </div>
                
                <div class="cart-list">
                    <div v-if="cartList.length === 0" style="text-align:center; padding:40px; color:#ccc;">
                        üõí Ë¥≠Áâ©ËΩ¶ÊòØÁ©∫ÁöÑ
                    </div>
                    <div class="cart-item" v-for="item in cartList" :key="item.id">
                        <div>
                            <div style="font-size:14px; font-weight:bold">[[ item.name ]]</div>
                            <div style="font-size:12px; color:#999">¬•[[ item.price ]]</div>
                        </div>
                        <div class="cart-control">
                            <button class="btn-control" @click="changeNum(item, -1)">-</button>
                            <span>[[ item.num ]]</span>
                            <button class="btn-control" @click="changeNum(item, 1)">+</button>
                        </div>
                    </div>
                </div>

                <div class="cart-footer">
                    <div class="checkout-section">
                        <div class="form-row">
                            <span class="row-label">Â∞±È§ê</span>
                            <div class="row-content">
                                <label class="radio-box">
                                    <input type="radio" name="type" value="1" v-model="orderType">
                                    <span>Â†ÇÈ£ü</span>
                                </label>
                                <label class="radio-box">
                                    <input type="radio" name="type" value="2" v-model="orderType">
                                    <span>ÊâìÂåÖ</span>
                                </label>
                            </div>
                        </div>
                    
                        <div class="form-row">
                            <span class="row-label">‰ºöÂëò</span>
                            <div class="row-content">
                                <input type="number" v-model="memberId" placeholder="ËæìÂÖ•‰ºöÂëòID (ÈÄâÂ°´)" class="clean-input">
                            </div>
                        </div>
                    
                        <div class="form-row">
                            <span class="row-label">ÊîØ‰ªò</span>
                            <div class="row-content">
                                <label class="radio-box">
                                    <input type="radio" name="bank" value="1" v-model="payType">
                                    <span>Áé∞Èáë</span>
                                </label>
                                <label class="radio-box">
                                    <input type="radio" name="bank" value="2" v-model="payType">
                                    <span>ÂæÆ‰ø°</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:18px;">
                        <span>ÂêàËÆ°</span>
                        <span style="color:red; font-weight:bold">¬•[[ totalPrice ]]</span>
                    </div>
                    <button class="btn-submit" @click="submitOrder">Á´ãÂç≥ÁªìÁÆó</button>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const serverData = {
            categories: [
                {% for key, category in categorylist %}
                {
                    id: "{{ category.id }}",
                    name: "{{ category.name }}",
                    pids: [
                        {% for product in category.pids %}
                        {
                            id: "{{ product.id }}",
                            name: "{{ product.name }}",
                            price: "{{ product.price }}",
                            cover_pic: "{{ product.cover_pic }}"
                        },
                        {% endfor %}
                    ]
                },
                {% endfor %}
            ],
            initialCart: [
                {% for product in request.session.cartlist.values %}
                {
                    id: "{{ product.id }}",
                    name: "{{ product.name }}",
                    price: "{{ product.price }}",
                    num: {{ product.num }},
                    cover_pic: "{{ product.cover_pic }}" 
                },
                {% endfor %}
            ]
        };
    </script>

    <script>
        const { createApp } = Vue;

        createApp({
            delimiters: ['[[', ']]'], 
            data() {
                return {
                    categories: serverData.categories,
                    cartList: serverData.initialCart,
                    currentCategory: 0,
                    orderType: '1',  // ÂØπÂ∫î HTML ÈáåÁöÑ v-model="orderType" (1=Â†ÇÈ£ü)
                    payType: '1',    // ÂØπÂ∫î HTML ÈáåÁöÑ v-model="payType"   (1=Áé∞Èáë)
                    memberId: ''     // ÂØπÂ∫î HTML ÈáåÁöÑ v-model="memberId"  (‰ºöÂëòID)
                }
            },
            computed: {
                totalPrice() {
                    return this.cartList.reduce((sum, item) => sum + (item.price * item.num), 0);
                },
                totalCount() {
                    return this.cartList.reduce((sum, item) => sum + item.num, 0);
                }
            },
            methods: {
                scrollToCategory(index) {
                    this.currentCategory = index;
                    const el = document.getElementById('cat-' + index);
                    if(el) el.scrollIntoView({ behavior: 'smooth' });
                },
                
                addToCart(product) {
                    // ‰ΩøÁî®ÂéüÁîü Django Ë∑ØÁî±
                    const url = "{% url 'web_cart_add' 0 %}".replace('0', product.id);
                    axios.get(url)
                        .then(res => {
                            const existing = this.cartList.find(item => item.id == product.id);
                            if (existing) {
                                existing.num++;
                            } else {
                                this.cartList.push({ ...product, num: 1 });
                            }
                        })
                        .catch(err => console.error(err));
                },

                changeNum(item, delta) {
                    const newNum = item.num + delta;
                    if (newNum < 1) {
                         const url = "{% url 'web_cart_delete' 0 %}".replace('0', item.id);
                         axios.get(url).then(() => {
                             this.cartList = this.cartList.filter(i => i.id !== item.id);
                         });
                         return;
                    }

                    axios.get("{% url 'web_cart_change' %}", {
                        params: { pid: item.id, num: newNum }
                    }).then(() => {
                        item.num = newNum;
                    });
                },

                clearCart() {
                    if(!confirm("Á°ÆÂÆöÊ∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶ÂêóÔºü")) return;
                    axios.get("{% url 'web_cart_clear' %}").then(() => {
                        this.cartList = [];
                    });
                },

                submitOrder() {
                    if (this.cartList.length === 0) {
                        alert("Ë¥≠Áâ©ËΩ¶‰∏∫Á©∫ÔºÅ");
                        return;
                    }
                    if (!confirm("Á°ÆÂÆöË¶ÅÁªìÁÆóÂêóÔºü")) return;

                    axios.get("{% url 'web_orders_insert' %}", {
                        params: {
                            bank: this.payType, // ‰Ω†ÁöÑÊîØ‰ªòÊñπÂºè
                            mid: this.memberId  // <--- ‰º†ËøáÂéªÁöÑ‰ºöÂëòID
                        }
                    }).then(res => {
                        // 3. Â§ÑÁêÜÂêéÁ´ØÁöÑËøîÂõûÁªìÊûú
                        if (res.data === "Y") {
                            alert("‰∏ãÂçïÊàêÂäüÔºÅ");
                            window.location.reload();
                        } else if (res.data === "NoMember") {
                            // <--- ‰∏ìÈó®Â§ÑÁêÜ‚ÄúÊú™Êü•ËØ¢Âà∞‰ºöÂëò‚ÄùÁöÑÊÉÖÂÜµ
                            alert("Êú™Êü•ËØ¢Âà∞Áõ∏Â∫î‰ºöÂëòÁî®Êà∑ÔºåËØ∑Ê£ÄÊü•IDÊòØÂê¶Ê≠£Á°ÆÔºÅ");
                        } else {
                            alert("‰∏ãÂçïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
                        }
                    });
                        }
                    }
        }).mount('#app');
    </script>
</body>
</html>