{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>订单中心</title>
    <link rel="stylesheet" href="{% static 'web/css/common.css' %}">
    <link rel="stylesheet" href="{% static 'uploads/iconfont/font_h51zhavl2bf/iconfont.css' %}">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .page-container { padding: 30px; max-width: 1200px; margin: 0 auto; }
        .panel { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
        .panel-head { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .panel-title { font-size: 18px; font-weight: bold; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        /* 表格样式 */
        .modern-table { width: 100%; border-collapse: collapse; }
        .modern-table th { background: #f8f9fa; padding: 15px; text-align: left; font-size: 14px; color: #666; font-weight: 600; }
        .modern-table td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; color: #333; }
        .modern-table tr:hover { background: #fcfcfc; }
        
        /* 状态标签 */
        .badge { padding: 4px 10px; border-radius: 4px; font-size: 12px; }
        .bg-green { background: #e8f5e9; color: #2e7d32; }
        .bg-red { background: #ffebee; color: #c62828; }
        .bg-yellow { background: #fff3e0; color: #ef6c00; }
        
        /* 按钮组 */
        .btn-mini { padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 12px; margin-right: 5px; }
        .btn-mini:hover { background: #f5f5f5; color: var(--primary); border-color: var(--primary); }
        
        /* 分页 */
        .pagination { padding: 20px; display: flex; justify-content: flex-end; gap: 5px; list-style: none;}
        .pagination a { padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #666; }
        .pagination .active a { background: var(--primary); color: #fff; border-color: var(--primary); }

        /* 模态框 */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 999; }
        .modal-box { background: #fff; width: 600px; max-height: 80vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; animation: popIn 0.3s; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .close-btn { cursor: pointer; font-size: 20px; color: #999; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div id="app">
        <header class="app-header">
            <div class="brand">
                <img src="{% static 'uploads/shop/' %}{{ request.session.shopinfo.cover_pic }}" 
                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"
                     onerror="this.src='https://placehold.co/40x40?text=Logo'"> 
                     <span>{{request.session.shopinfo.name}}</span>
                <span style="font-size:12px; color:#999; margin-left:10px">{{request.session.shopinfo.shop}}</span>
            </div>
            <nav class="nav-links">
                <a href="{% url 'web_index'%}">堂食点餐</a>
                <a href="{% url 'web_orders_index' 1 %}?status=1" class="{% if request.GET.status == '1' %}active{% endif %}">当前订单</a>
                <a href="{% url 'web_orders_index' 1 %}?status=3" class="{% if request.GET.status == '3' %}active{% endif %}">历史订单</a>
                <a href="{% url 'web_logout' %}">退出</a>
            </nav>
        </header>

        <div class="page-container">
            <div class="panel">
                <div class="panel-head">
                    <div class="panel-title">订单管理</div>
                    <a href="{{url}}" class="btn-mini"><span class="iconfont icon-refresh"></span> 刷新列表</a>
                </div>
                
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>顾客/操作员</th>
                            <th>总金额</th>
                            <th>状态</th>
                            <th>支付</th>
                            <th>时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vo in orderslist %}
                        <tr id="tr-{{vo.id}}">
                            <td>#{{ vo.id }}</td>
                            <td>
                                <div>{{vo.membername}}</div>
                                <div style="font-size:12px; color:#999">操作员: {{ vo.nickname }}</div>
                            </td>
                            <td style="color:#e74c3c; font-weight:bold">¥{{vo.money}}</td>
                            <td>
                                {% if vo.status == 1 %}<span class="badge bg-yellow">制作中</span>
                                {% elif vo.status == 2 %}<span class="badge bg-red">无效</span>
                                {% elif vo.status == 3 %}<span class="badge bg-green">已完成</span>
                                {% else %}<span class="badge">未知</span>{% endif %}
                            </td>
                            <td>
                                {% if vo.payment_status == 1 %}<span style="color:#e74c3c">未支付</span>
                                {% elif vo.payment_status == 2 %}<span style="color:#2ecc71">已支付</span>
                                {% elif vo.payment_status == 3 %}<span style="color:#999">已退款</span>{% endif %}
                            </td>
                            <td style="color:#999; font-size:12px">{{ vo.create_at|date:'Y-m-d H:i' }}</td>
                            <td>
                                <button class="btn-mini" @click="showDetail({{vo.id}})">详情</button>
                                {% if vo.status == 1 %}
                                <button class="btn-mini" @click="changeStatus({{vo.id}}, 3)">完成</button>
                                <button class="btn-mini" style="color:red; border-color:#fadbd8" @click="changeStatus({{vo.id}}, 2)">删除</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <ul class="pagination">
                    <li><a href="{% url 'web_orders_index' pIndex|add:-1 %}">&laquo;</a></li>
                    {% for p in plist %}
                    <li class="{% if pIndex == p %}active{% endif %}"><a href="{% url 'web_orders_index' p %}">{{ p }}</a></li>
                    {% endfor %}
                    <li><a href="{% url 'web_orders_index' pIndex|add:1 %}">&raquo;</a></li>
                </ul>
            </div>
        </div>

        <div class="modal-mask" v-if="showModal" @click.self="showModal = false">
            <div class="modal-box">
                <div class="modal-header">
                    <span>订单详情</span>
                    <span class="close-btn" @click="showModal = false">&times;</span>
                </div>
                <div class="modal-body" v-html="detailContent"></div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            delimiters: ['[[', ']]'],
            data() {
                return {
                    showModal: false,
                    detailContent: '加载中...'
                }
            },
            methods: {
                showDetail(oid) {
                    this.showModal = true;
                    this.detailContent = '<div style="text-align:center;padding:20px;">加载中...</div>';
                    // 请求 detail.html
                    axios.get("{% url 'web_orders_detail' %}", { params: { oid: oid } })
                        .then(res => {
                            this.detailContent = res.data;
                        })
                        .catch(err => {
                            this.detailContent = '加载失败';
                        });
                },
                changeStatus(oid, status) {
                    const tips = { 2: "确定删除这个订单吗？", 3: "确定完成这个订单吗？" };
                    if (!confirm(tips[status])) return;

                    axios.get("{% url 'web_orders_status' %}", { params: { oid: oid, status: status } })
                        .then(res => {
                            if (res.data === "Y") {
                                // 简单刷新页面
                                window.location.reload();
                            } else {
                                alert("操作失败");
                            }
                        });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>